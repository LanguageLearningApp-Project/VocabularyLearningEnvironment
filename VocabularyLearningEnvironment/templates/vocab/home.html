{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}  
    <div class="d-flex justify-content-end p-2">
        {% if request.user %}
            <small>
            {{ request.user.username}} |
            <a href="{% url 'logout' %}">Logout</a>
            </small>
        {% endif %}
    </div>

  <h1>Vocabulary Training</h1>

  <div class="question-box" id="questionbox">
    Question goes here..
  </div>

  <input id="answer" name="given_answer" type="text" placeholder="Type your answer…"
         style="font-size:18px; width:300px; padding:8px; border:2px solid #2d6aa6; border-radius:8px; margin-top:20px;">

  <div class="btn-row">
    <button id="check" class="btn">Check Answer</button>
    <button id="quit"  class="btn">Quit</button>
  </div>

  <pre id="out" style="margin:8px 0 0; font-size:16px;"></pre>
  <p id="progress" style="margin-top:20px; font-weight:600;"></p>
  
  <style>
    .container {
      background-color: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      width: 95%;
      height: 60vh;
      max-width: 700px;
      text-align: center;
      margin-top: 70px;
    }
    h1 {
      color: #1e4eb6;
      font-size: 2.7em;
      margin-bottom: 30px;
      font-weight: bold;
    }

    .question-box {
      font-size:18px;
      width:400px;
      padding:8px;
      border:2px solid #2d6aa6;
      background-color:#d3e2f1;
      border-radius:8px;
      margin: 50px auto 0 auto;
      display: block;
    }

    .btn-row {
      display:flex;
      gap:12px;
      margin: 20px auto 0 auto;
      display: block;
    }

    .btn{
      font-size:18px; background:#2d6aa6; color:#fff;
      padding:10px 16px; border:0; border-radius:10px;
      cursor:pointer; font-weight:600;
    }
    .btn:hover{
      filter:brightness(1.05);
    }
  </style>
{% endblock %}

{% block extra_js %}
<script>
let quizFinished = false;
function getCSRF() {
  const m = document.querySelector('meta[name="csrf-token"]');
  if (m && m.content && m.content !== 'NOTPROVIDED') return m.content;
  const c = document.cookie.match(/(^|;\s*)csrftoken=([^;]+)/);
  return c ? decodeURIComponent(c[2]) : '';
}

document.querySelectorAll('.quiz-restart').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.dataset.sessionId;
    if (!confirm('Restart this quiz? Score and progress will be reset.')) return;

    try {
      const r = await fetch(`/sessions/${id}/restart_quiz/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCSRF(),
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: '' 
      });

      const j = await r.json().catch(()=>({}));
      if (!r.ok) {
        alert(j.message || 'Could not reset quiz.');
        return;
      }

      alert(`Quiz reset. ${j.question_count} questions ready.`);

      const card = document.getElementById(`quiz-session-${id}`);
      if (card) {
        const h4 = card.querySelector('h4');
        if (h4) {
          const lines = h4.innerHTML.split('<br>');
          if (lines.length >= 3) {
            lines[2] = `Questions: ${j.question_count}`;
            h4.innerHTML = lines.join('<br>');
          }
        }
      }
    } catch (err) {
      console.error(err);
      alert('Network error while resetting the quiz.');
    }
  });
});
function post(url, data={}) {
  return fetch(url, {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type':'application/x-www-form-urlencoded', 'X-CSRFToken': getCSRF() },
    body: new URLSearchParams(data)
  });
}

const box      = document.getElementById("questionbox");
const answerEl = document.getElementById("answer");
const quitBtn  = document.getElementById("quit");
const checkBtn = document.getElementById("check");

let currentTranslation = "";
let currentQuestionId = null;

const progressEl = document.getElementById("progress") || (() => {
  const p = document.createElement("p");
  p.id = "progress";
  document.querySelector(".btn-row")?.after(p) || document.body.appendChild(p);
  return p;
})();

const urlParams = new URLSearchParams(window.location.search);
const sessionId = urlParams.get('session_id');
const csrftoken = '{{ csrf_token }}';

let goalType = null;
async function fetchGoalType() {
  try {
    const r = await fetch(`/sessions/${sessionId}/info/`, { credentials: 'same-origin' });
    const j = await r.json();
    goalType = j.goal_type; // "minutes_per_day" | "reviews_per_day | quiz sessions"
  } catch (_) { goalType = null; }
}

async function submitAnswer(questionId, givenAnswer) {
  try {
    const formData = new FormData();
    formData.append('question_id', questionId);
    formData.append('given_answer', givenAnswer);
    formData.append('csrfmiddlewaretoken', csrftoken);
    formData.append('session_id', sessionId);

    const response = await fetch('/submit-answer/', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    });

    const result = await response.json();
    console.log('Answer saved:', result);
  } catch (error) {
    console.error('Error:', error);
  }
}

function renderDone(message) {
  box.innerHTML = `<strong>Quiz complete </strong><br><em>${message || ""}</em>`;
  answerEl.value = "";
  answerEl.disabled = true;
  checkBtn.disabled = true;

  quitBtn.onclick = () => { window.location.href = "{% url 'user_page' %}"; };
}

function renderError(message) {
  box.innerHTML = `
    <strong>Oops!</strong><br/>
    <em>${message || "Could not load word."}</em>
  `;
  answerEl.value = "";
  answerEl.disabled = true;
  checkBtn.disabled = true;
  quitBtn.textContent = "Back to Dashboard";
  quitBtn.onclick = () => { window.location.href = "{% url 'user_page' %}"; };
}



async function loadWord() {
  try {
    const res = await fetch(`/random-word/?session_id=${encodeURIComponent(sessionId)}`, { cache: 'no-store', credentials: 'same-origin' });
    const data = await res.json();

    if (data.status === "done") {
      quizFinished = true;
      const score = (typeof data.score === "number") ? data.score : 0;
      const total = (typeof data.total === "number") ? data.total : 0;
      box.innerHTML = `
        <strong>${data.message || "Quiz complete."}</strong><br/>
        <div style="margin-top:8px;">Score: <b>${score}</b> / <b>${total}</b></div>
      `;
      answerEl.disabled = true;
      checkBtn.disabled = true;
      quitBtn.textContent = "Back to Dashboard";
      return; 
    }

    if (data.status === "error") {
      renderError(data.message);
      return;
    }
    
    box.innerHTML = `
      <strong>${data.word}</strong><br>
      <em style="color: gray;">${data.translation || "(no translation)"}</em>
    `;
    currentTranslation = (data.translation || "").trim();
    currentQuestionId = data.question_id;
    answerEl.style.backgroundColor = "";
  } catch (e) {
    box.textContent = "Could not load word ";
    console.error(e);
  }
}

checkBtn.addEventListener("click", async () => {
  const val = answerEl.value.trim();

  if (currentQuestionId) {
    await submitAnswer(currentQuestionId, val || "");
  }

  if (val.toLowerCase() === (currentTranslation || "").toLowerCase()) {
    answerEl.style.backgroundColor = "rgba(154, 255, 154, 0.6)";
  } else {
    answerEl.style.backgroundColor = "rgba(255, 182, 193, 0.6)";
  }

  if (quizFinished) return;

  setTimeout(() => {
    answerEl.value = "";
    answerEl.style.backgroundColor = "";
    answerEl.focus();
    loadWord();
  }, 500);
});


let heartbeatId = null;
let ending = false;

async function startTimer() {
  await post('/study/start/', { study_session_id: sessionId });
}
function startHeartbeat() {
  if (heartbeatId) return;
  heartbeatId = setInterval(() => {
    post('/study/update_time/').catch(()=>{});
  }, 60000); // every 1 minutes the records are sent to the database
}
function stopHeartbeat() {
  if (heartbeatId) clearInterval(heartbeatId);
  heartbeatId = null;
}
async function endTimer() {
  if (ending) return;
  ending = true;
  try {
    await fetch('/study/end/', {
      method: 'POST',
      keepalive: true,
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCSRF() },
      body: '' 
    });
  } catch(_) {}
  stopHeartbeat();
}

if (quitBtn) {
  quitBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (goalType === 'minutes_per_day') { await endTimer(); }
    window.location.href = "{% url 'user_page' %}";
  }, { once: true });
}
window.addEventListener('pagehide', () => {
  if (goalType === 'minutes_per_day') { endTimer(); }
}, { once: true });

(async function boot(){
  if (!sessionId) {
    box.textContent = 'Pick a study session from your dashboard (User Page → Study).';
    return;
  }
  await fetchGoalType();

  if (goalType === 'minutes_per_day') {
    startTimer().then(startHeartbeat);
  }
  loadWord(); 

})();

</script>
{% endblock %}
